{"version":3,"sources":["../../src/dialog/janitor.js"],"names":["module","exports","db","botfile","middlewares","intervalRef","defaultJanitorInterval","_","get","defaultTimeout","checkStaleSessions","knex","timedOutCondition","date","isBefore","subtract","sessions","where","andWhereRaw","limit","then","Promise","map","platform","props","sessionId","session","id","includes","chunks","split","head","userId","tail","join","user","sendIncoming","type","raw","text","run","uninstall","clearInterval","install","randomMs","Math","random","setInterval","runOnce"],"mappings":";;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;AAEAA,OAAOC,OAAP,GAAiB,CAAC,EAAEC,EAAF,EAAMC,OAAN,EAAeC,WAAf,EAAD,KAAkC;AACjD,MAAIC,cAAc,IAAlB;;AAEA,QAAMC,yBAAyB,kBAAGC,iBAAEC,GAAF,CAAML,OAAN,EAAe,yBAAf,EAA0C,KAA1C,CAAH,CAA/B;AACA,QAAMM,iBAAiB,kBAAGF,iBAAEC,GAAF,CAAML,OAAN,EAAe,yBAAf,EAA0C,KAA1C,CAAH,CAAvB;;AAEA,QAAMO;AAAA,iCAAqB,aAAY;AACrC,YAAMC,OAAO,MAAMT,GAAGM,GAAH,EAAnB;;AAEA,YAAMI,oBAAoB,uBAAQD,IAAR,EAAcE,IAAd,CAAmBC,QAAnB,CACxB,WADwB,EAExB,wBAASC,QAAT,CAAkBN,cAAlB,EAAkC,cAAlC,CAFwB,CAA1B;;AAKA,YAAMO,WAAW,MAAML,KAAK,iBAAL,EACpBM,KADoB,CACdL,iBADc,EAEpBM,WAFoB,CAEP,yCAFO,EAEmC;AAFnC,OAGpBC,KAHoB,CAGd,GAHc,EAIpBC,IAJoB,EAAvB;;AAMA,aAAOC,mBAAQC,GAAR,CAAYN,QAAZ,EAAsB,mBAAW;AACtC,YAAIO,WAAW,UAAf;AACA,cAAMC,QAAQ,EAAd;AACA,cAAMC,YAAYC,QAAQC,EAA1B;;AAEA,YAAIF,UAAUG,QAAV,CAAmB,GAAnB,CAAJ,EAA6B;AAC3B,gBAAMC,SAASJ,UAAUK,KAAV,CAAgB,GAAhB,CAAf;AACAP,qBAAWhB,iBAAEwB,IAAF,CAAOF,MAAP,CAAX;AACA,gBAAMG,SAASzB,iBAAE0B,IAAF,CAAOJ,MAAP,EAAeK,IAAf,CAAoB,GAApB,CAAf;AACAV,gBAAMW,IAAN,GAAa,EAAER,IAAIK,MAAN,EAAb;AACD;;AAED,eAAO5B,YAAYgC,YAAZ;AACLb,kBADK;AAELc,gBAAM,mBAFD;AAGLC,eAAK,EAAEb,SAAF,EAHA;AAILc,gBAAMd,SAJD;AAKLA;AALK,WAMFD,KANE,EAAP;AAQD,OApBM,CAAP;AAqBD,KAnCK;;AAAA;AAAA;AAAA;AAAA,MAAN;;AAqCA,QAAMgB,MAAM,MAAM9B,oBAAlB;;AAEA,QAAM+B,YAAY,MAAM;AACtB,QAAIpC,WAAJ,EAAiB;AACfqC,oBAAcrC,WAAd;AACAA,oBAAc,IAAd;AACD;AACF,GALD;;AAOA,QAAMsC,UAAU,MAAM;AACpB,UAAMC,WAAWC,KAAKC,MAAL,KAAgB,IAAjC;;AAEA,QAAIzC,WAAJ,EAAiB;AACfoC;AACD;;AAEDpC,kBAAc0C,YAAYP,GAAZ,EAAiBlC,yBAAyBsC,QAA1C,CAAd;AACD,GARD;;AAUA,SAAO,EAAED,OAAF,EAAWF,SAAX,EAAsBO,SAASR,GAA/B,EAAP;AACD,CA/DD","file":"janitor.js","sourcesContent":["import ms from 'ms'\nimport helpers from '../database/helpers'\nimport moment from 'moment'\nimport _ from 'lodash'\nimport Promise from 'bluebird'\n\nmodule.exports = ({ db, botfile, middlewares }) => {\n  let intervalRef = null\n\n  const defaultJanitorInterval = ms(_.get(botfile, 'dialogs.janitorInterval', '30s'))\n  const defaultTimeout = ms(_.get(botfile, 'dialogs.timeoutInterval', '15m'))\n\n  const checkStaleSessions = async () => {\n    const knex = await db.get()\n\n    const timedOutCondition = helpers(knex).date.isBefore(\n      'active_on',\n      moment().subtract(defaultTimeout, 'milliseconds')\n    )\n\n    const sessions = await knex('dialog_sessions')\n      .where(timedOutCondition)\n      .andWhereRaw(`not \"id\" like '%\\\\_\\\\_\\\\_%' escape '\\\\'`) // Exclude substates\n      .limit(250)\n      .then()\n\n    return Promise.map(sessions, session => {\n      let platform = 'botpress'\n      const props = {}\n      const sessionId = session.id\n\n      if (sessionId.includes(':')) {\n        const chunks = sessionId.split(':')\n        platform = _.head(chunks)\n        const userId = _.tail(chunks).join(':')\n        props.user = { id: userId }\n      }\n\n      return middlewares.sendIncoming({\n        platform,\n        type: 'bp_dialog_timeout',\n        raw: { sessionId },\n        text: sessionId,\n        sessionId,\n        ...props\n      })\n    })\n  }\n\n  const run = () => checkStaleSessions()\n\n  const uninstall = () => {\n    if (intervalRef) {\n      clearInterval(intervalRef)\n      intervalRef = null\n    }\n  }\n\n  const install = () => {\n    const randomMs = Math.random() * 5000\n\n    if (intervalRef) {\n      uninstall()\n    }\n\n    intervalRef = setInterval(run, defaultJanitorInterval + randomMs)\n  }\n\n  return { install, uninstall, runOnce: run }\n}\n"]}