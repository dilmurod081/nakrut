{"version":3,"sources":["../../src/server/static.js"],"names":["module","exports","bp","serveModule","app","name","shortName","util","getModuleShortname","settings","menuIcon","iconRequestPath","iconPath","path","join","root","get","req","res","contentType","sendFile","err","logger","warn","liteDir","settingsKey","webBundle","bundlePath","params","subview","content","fs","readFileSync","send","sendStatus","serveCustomTheme","customTheme","licensing","getFeatures","whitelabel","themeLocation","projectLocation","existsSync","use","serveMedia","contents","mediaManager","readFile","filename","type","extname","set","install","_loadedModules","getHeaders","includes","body","replace","tokenExpiry","enabled","authEnabled","useCloud","botfile","login","ghostEnabled","ghostContent","optOutStats","appName","isUsingCloud","cloud","isPaired","pairingInfo","botId","endpoint","teamId","env","Object","assign","getPairingInfo","token","isFirstRun","version","process","NODE_ENV","JSON","stringify","isDeveloping","BOTPRESS_FLOW_EDITOR_DISABLED","botpressPath","next","test","headers","accept","url"],"mappings":"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","file":"static.js","sourcesContent":["import { static as staticMiddleware } from 'express'\nimport path from 'path'\nimport fs from 'fs'\nimport ms from 'ms'\nimport util from '../util'\nimport yn from 'yn'\nimport tamper from 'tamper'\n\nmodule.exports = bp => {\n  const serveModule = (app, module) => {\n    const name = module.name\n    const shortName = util.getModuleShortname(module.name)\n\n    if (module.settings.menuIcon === 'custom') {\n      const iconRequestPath = `/img/modules/${name}.png`\n      const iconPath = path.join(module.root, 'icon.png')\n\n      app.get(iconRequestPath, (req, res) => {\n        try {\n          res.contentType('image/png')\n          res.sendFile(iconPath)\n        } catch (err) {\n          bp.logger.warn(`Could not serve module icon [${name}] at: ${iconPath}`)\n        }\n      })\n    }\n\n    const liteDir = path.join(module.root, module.settings.liteDir || 'bin/lite')\n\n    app.get(\n      [\n        `/js/modules/${shortName}`, // The full module view\n        `/js/modules/${name}.js`, // <<-- DEPRECATED: Will be removed shortly. Only use shortNames\n        `/js/modules/${shortName}/:subview` // Lite view\n      ],\n      (req, res) => {\n        const settingsKey = module.settings.webBundle\n        const bundlePath =\n          req.params && req.params.subview\n            ? path.join(liteDir, req.params.subview + '.bundle.js') // Render lite view\n            : path.join(module.root, settingsKey || 'bin/web.bundle.js')\n\n        try {\n          const content = fs.readFileSync(bundlePath)\n          res.contentType('text/javascript')\n          res.send(content)\n        } catch (err) {\n          bp.logger.warn(`Could not serve module [${name}] at: ${bundlePath}`)\n          res.sendStatus(404)\n        }\n      }\n    )\n  }\n\n  const serveCustomTheme = app => {\n    let customTheme = ''\n\n    if (bp.licensing.getFeatures().whitelabel === true) {\n      const themeLocation = path.join(bp.projectLocation, 'theme.css')\n      if (fs.existsSync(themeLocation)) {\n        customTheme = fs.readFileSync(themeLocation)\n      }\n    }\n\n    app.use('/style/custom-theme.css', (req, res) => {\n      res.contentType('text/css')\n      res.send(customTheme)\n    })\n  }\n\n  const serveMedia = app => {\n    app.get('/media/:filename', async (req, res) => {\n      const contents = await bp.mediaManager.readFile(req.params.filename)\n      if (!contents) {\n        return res.sendStatus(404)\n      }\n      const type = path.extname(req.params.filename)\n      // files are never overwritten because of the unique ID\n      // so we can set the header to cache the asset for 1 year\n      return res\n        .set({ 'Cache-Control': 'max-age=31556926' })\n        .type(type)\n        .send(contents)\n    })\n  }\n\n  const install = async app => {\n    for (const name in bp._loadedModules) {\n      const module = bp._loadedModules[name]\n      serveModule(app, module)\n    }\n\n    app.use(\n      tamper(function(req, res) {\n        const contentType = res.getHeaders()['content-type']\n        if (!contentType || !contentType.includes('text/html')) {\n          return\n        }\n\n        return function(body) {\n          return body.replace(/\\$\\$BP_BASE_URL\\$\\$/g, '')\n        }\n      })\n    )\n\n    app.use('/js/env.js', async (req, res) => {\n      const { tokenExpiry, enabled: authEnabled, useCloud } = bp.botfile.login\n      const { enabled: ghostEnabled } = bp.botfile.ghostContent\n      const optOutStats = !!bp.botfile.optOutStats\n      const appName = bp.botfile.appName || 'Botpress'\n\n      const isUsingCloud = !!useCloud && (await bp.cloud.isPaired())\n      const pairingInfo = { botId: '', endpoint: '', teamId: '', env: bp.botfile.env }\n      if (isUsingCloud) {\n        Object.assign(pairingInfo, await bp.cloud.getPairingInfo())\n        delete pairingInfo.token\n      }\n\n      const { isFirstRun, version } = bp\n      res.contentType('text/javascript')\n      res.send(`(function(window) {\n        window.NODE_ENV = \"${process.env.NODE_ENV || 'development'}\";\n        window.BOTPRESS_ENV = \"${bp.botfile.env}\";\n        window.BP_BASE_PATH = \"\";\n        window.BOTPRESS_CLOUD_ENABLED = ${isUsingCloud};\n        window.BOTPRESS_CLOUD_SETTINGS = ${JSON.stringify(pairingInfo)};\n        window.DEV_MODE = ${util.isDeveloping};\n        window.AUTH_ENABLED = ${!!authEnabled};\n        window.AUTH_TOKEN_DURATION = ${ms(tokenExpiry)};\n        window.OPT_OUT_STATS = ${optOutStats};\n        window.SHOW_GUIDED_TOUR = ${isFirstRun};\n        window.BOTPRESS_VERSION = \"${version}\";\n        window.APP_NAME = \"${appName}\";\n        window.GHOST_ENABLED = ${!!ghostEnabled};\n        window.BOTPRESS_FLOW_EDITOR_DISABLED = ${yn(process.env.BOTPRESS_FLOW_EDITOR_DISABLED)};\n      })(typeof window != 'undefined' ? window : {})`)\n    })\n\n    serveCustomTheme(app)\n\n    serveMedia(app)\n\n    app.use(staticMiddleware(path.join(bp.projectLocation, 'static')))\n\n    app.use(staticMiddleware(path.join(bp.botpressPath, './lib/web')))\n\n    app.get('*', (req, res, next) => {\n      // If browser requests HTML and request isn't an API request\n      if (/html/i.test(req.headers.accept) && !/^\\/api\\//i.test(req.url)) {\n        if (req.url && /^\\/lite\\//i.test(req.url)) {\n          return res.sendFile(path.join(bp.botpressPath, './lib/web/lite/index.html'))\n        }\n\n        return res.sendFile(path.join(bp.botpressPath, './lib/web/index.html'))\n      }\n      next()\n    })\n\n    return true\n  }\n\n  return { install }\n}\n"]}